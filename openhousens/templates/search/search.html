{% extends 'speeches/base.html' %}
{% load url from future %}
{% load speech_utils legislature_extras pagination %}

{% block title %}Search{% if query %}: {{ query }}{% endif %}{% endblock %}

{% block content %}
{% include 'speeches/_breadcrumbs.html' %}
{% long_paginator as pagination %}

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-10 col-md-8 col-sm-offset-2">
      <h1>Search</h1>

      <form action="{% url 'legislature:haystack_search' %}" method="get" class="form-inline form-inline-always" role="form">
        <div class="form-group">
          <label class="sr-only" for="q">Enter a bill, keyword or name</label>
          <input name="q" id="q" type="search" class="form-control" placeholder="Enter a bill, keyword or name" value="{% if form.q.value %}{{ form.q.value }}{% endif %}">
        </div>
        <button type="submit" class="btn btn-default">
          <span class="hidden-xs">Search</span>
          <span class="visible-xs-inline">
            <span class="glyphicon glyphicon-search"></span>
          </span>
        </button>
{% if form.speaker %}
        <div class="checkbox">
          <label>
            <input type="checkbox" name="p" value="{{ form.p.value }}" checked>
            Search only speeches by
            <a href="{% url 'legislature:speaker-view' form.speaker.slug %}">{{ form.speaker }}</a>
          </label>
        </div>
{% endif %}
      </form>
    </div>
  </div>

{% if query %}
  {% if speaker_results %}
  <div class="row push-down">
    <div class="col-sm-10 col-md-8 col-sm-offset-2">
      <h2>Speakers</h2>
      <ul class="list-inline">
        {% for result in speaker_results %}<li>
          <a href="{% url 'legislature:speaker-view' result.object.slug %}">
            <div class="avatar avatar-sm"{% if result.object.image %} style="background-image: url({{ result.object.image }})"{% endif %}></div>
          </a>
          <a href="{% url 'legislature:speaker-view' result.object.slug %}" class="highlighted">
            {{ result.highlighted.0|person_name|striptags_highlight }}
          </a>
        </li>{% endfor %}
        </ul>
    </div>
  </div>
  {% endif %}

  {% if page.object_list %}
  <div class="row push-down">
    <div class="col-sm-10 col-md-8 col-sm-offset-2">
      <h2>Speeches <small>Results {{ page.start_index }}â€“{{ page.end_index }} of {{ paginator.count }}</small></h2>
      <p class="order">
        Sort by
    {% if request.GET.sort == "newest" %}
        <a href="{% url 'legislature:haystack_search' %}?q={{ form.q.value }}{% if form.speaker %}&amp;p={{ form.p.value }}{% endif %}">relevance</a>
        or
        <span class="active">newest first</span>
    {% else %}
        <span class="active">relevance</span>
        or
        <a href="{% url 'legislature:haystack_search' %}?q={{ form.q.value }}{% if form.speaker %}&amp;p={{ form.p.value }}{% endif %}&amp;sort=newest">newest first</a>
    {% endif %}
      </p>
    </div>
  </div>

  <div class="speeches">
    {% for result in page.object_list %}
    <div class="row row-speech {{ result.object|speech_class }}">
      <div class="col-sm-2 col-meta hidden-xs">
        <a href="{{ result.object.section.start_date|hansard_url }}">
          {{ result.object.section.start_date|date:"F jS, Y" }}
        </a>
      {% if result.object.section.parent.parent_id %}
        <div class="heading-level-1">{{ result.object.section.parent.title|heading }}</div>
        <div class="heading-level-2">{{ result.object.section.title|heading }}</div>
        {% if result.object.title %}
        <div class="heading-level-3">{{ result.object.title|heading }}</div>
        {% endif %}
      {% elif result.object.section.parent_id %}
        <div class="heading-level-1">{{ result.object.section.title|heading }}</div>
        {% if result.object.title %}
        <div class="heading-level-2">{{ result.object.title|heading }}</div>
        {% endif %}
      {% endif %}
      </div>
      <div class="col-sm-10 col-speech" id="s{{ speech.id }}">
{% include 'speeches/speech.html' with speech=result.object with_speaker=1 highlight=result.highlighted.0 %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="row push-down">
    <div class="col-sm-10 col-md-8 col-sm-offset-2">
      <h2>No speeches found</h2>
    </div>
  </div>
  {% endif %}

  <div class="row">
    <div class="col-sm-10 col-md-8 col-sm-offset-2">
{{ pagination }}
    </div>
  </div>
{% endif %}
    </div>
  </div>
</div>
{% endblock %}
